<!--
    Styles defined here carry into the __preview because it's embedded HTML.
    So any styles names common to the editor's HTML will pick up the styles used in the editor!
    Javascript does not run because the document is already "ready".

let el = document.getElementById('div');

$(el).css('width')
$(el).css('width', '50%')

Things classes are used for:

classes
    specific styles where the CSS is typically one line
    style of a component where the CSS will typically include many styles
selectors in JS

-->

<head>
    <script src='https://code.jquery.com/jquery-3.4.1.min.js'></script>
</head>

<style>
    /* https://developer.mozilla.org/en-US/docs/Web/CSS/Using_CSS_custom___properties */
    :root {
        --__propertyWidth: 280px;  /* TODO: Why is this not equal to plw + pfw? */
        --__toolbarHeight: 30px;
        --__propertyLabelWidth: 120px;
        --__propertyFieldWidth: 115px;
    }
/*
    div {
        border-style:solid;
        border-width: 1px;
    }

    table {
        border-style:solid;
        border-width: 1px;
    }

    th {
        border-style:solid;
        border-width: 1px;
    }

    tr {
        border-style:solid;
        border-width: 1px;
    }

    td {
        border-style:solid;
        border-width: 1px;
    }
*/
    body {
        padding:0; 
        margin:0;
    }

    textarea {
        border-style:none;
    }

    .__noborders {
        border-collapse: collapse;    
    }

    .__border1 {
        border-style:solid;
        border-width: 1px;
    }
    
    .__vscroll {
        overflow-y:scroll;
    }

/* Absolution positioning should be avoided like the plague! */
/*
    .__fullscreen {
        height: 100%;
        width: 100%; 
        position: absolute; 
        top: 0; 
        bottom: 0; 
        left: 0; 
        right: 0;
        table-layout: fixed;
    }
*/

    .__fullscreen {
        width:calc(100% - 5px); 
        height:calc(100vh - 35px); /* why can't I use var(--toolbarHeight) ? */
        padding: 0;
        margin: 0;
    }

/*
    .__fullscreenv {
        height: 100%;
        width: calc(100% - (var(--__propertyWidth) + 2px)); 
        position: absolute; 
        top: 0; 
        bottom: 0; 
        left: 0; 
        right: 0;
    }
*/

    .__editorhw {
        width: calc(100% - var(--__propertyWidth));
    }

    .__properties {
        width: var(--__propertyWidth);
    }

    .__taeditorh {
        height: calc(100% - var(--__toolbarHeight));
        width: 100%;
        resize: none;
        padding: 0;
        margin: 0;
        white-space:normal;   /* or auto? */
        overflow: auto;
    }

    .__taeditorv {
        height: 100%;
        width: 100%;
        resize: none;
        padding: 0;
        margin: 0;
        white-space:normal;   /* or auto? */
        overflow: auto;
    }

    .__h100p {
        height: 100%;
    }

    .__text-bold {
        font-weight: bold;
    }

    .__mw1px {
        max-width: 1px;
    }

    .__preview {
        overflow: auto;
        white-space: normal;
    }

    .__fixed {
        table-layout: fixed;
    }

    .__fill {
        width:100%; 
        height:100%;
    }

    .__vamiddle {
        vertical-align: middle;
    }

    .__toolbar {
        height: var(--__toolbarHeight);
        width: 100%;
        padding-left: 5px;
    }

    .__parent {display: table;}

    .__child-top-left {
        display: table-cell;
    }

    .__child-middle-left {
        display: table-cell;
        vertical-align: middle;
        text-align: left;
    }

    .__child-middle-center {
        display: table-cell;
        vertical-align: middle;
        text-align: center;
    }

    .__child-bottom-right {
        display: table-cell;
        vertical-align: bottom;
        text-align: right;
    }

    .__hidden {
        display: none;
    }

    .__propertyLabel {
        float: left;   /* without this, width is ignored */
        width: var(--__propertyLabelWidth);
    }

    .__inputPropertyField {
        width: var(--__propertyFieldWidth);
        margin-left: 5px;
    }

    .__checkboxPropertyField {
        margin-left: 5px;
    }

    .__propertyItem {
        margin-bottom:3px;
        padding-left: 5px;
    }

    .__section {
        background-color: #ddd;
        margin-top: 7px;
        margin-bottom: 3px;
    }

    .__sectionBar {
        padding-left: 5px;
        padding-bottom: 1px;
    }

</style>

<body>
    <!-- 3 Horizontal panels -->

    <div class='__fullscreen __hidden' id='__horizontalView'>    
        <div class='__parent __toolbar'>
            <div class="__child-middle-left __buttonBar"></div>
        </div>
        <table class='__noborders __fixed __fill'>
            <tr>
                <td class='__editorhw'>
                    <div class='__h100p __border1'>
                        <textarea class='__taeditorh' id='__editorh'></textarea>
                    </div>
                </td>
                <td class='__mw1px'>
                    <div class='__preview __h100p __border1' id='__previewh'></div>
                </td>
                <td class='__properties'>
                    <div class='__h100p  __border1 __vscroll'>
                        <div class='__propertiesContainer'></div>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <!-- top and bottom editor and __preview with __properties sidebar -->

    <div class='__fullscreen' id='__verticalView'>
        <table class='__noborders __fill'>
            <tr style='height:1px;'>
                <div class='__parent __toolbar'>
                    <div class="__child-middle-left __buttonBar"></div>
                </div>
            </tr>
            <tr>
                <td>
                    <table class='__noborders __fill'>
                        <tr>
                            <td>
                                <div class='__h100p __border1'>
                                    <textarea class='__taeditorv' id='__editorv'></textarea>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td class='__mw1px'>
                                <div class='__preview __border1 __h100p' id='__previewv'></div>
                            </td>
                        </tr>
                    </table>
                </td>
                <td class='__properties'>
                    <div class='__h100p __border1'>
                        <div class='__propertiesContainer'></div>
                </td>
            </tr>
        </table>
    </div>    

    <!-- Templates: -->

    <div class='__hidden' id='__sourceButtonBar'>
        <button class='__showHorizontal'>Horizontal</button>
        <button class='__showVertical'>Vertical</button>
        <button class='__clearEditors'>Clear</button>
        <button class='__save'>Save</button>
    </div>

    <div class='__hidden' id = '__sourcePropertiesContainer'>
        <div class='__propertyItem'>Element: <span class='__text-bold __elementTagName'></span></div>
        <div class='__propertyItem'><span class='__propertyLabel'>Name:</span><input class='__inputPropertyField __propertyName'></div>
        <div class='__propertyItem'><span class='__propertyLabel'>ID:</span><input class='__inputPropertyField __propertyId'></div>
        <div id='__sections'></div>
    </div>

    <div class='__hidden' id = '__sectionTemplate'>
        <div class='__propertItem __section __sectionBar __sectionName{sectionName}'>{sectionName}</div>
    </div>

    <div class='__hidden' id = '__inputStyleTemplate'>
        <div class='__propertyItem'><span class='__propertyLabel'>{name}:</span><input class='__inputPropertyField' id='__inputProperty{name}' cssName='{name}'></div>
    </div>

    <div class='__hidden' id = '__checkboxStyleTemplate'>
        <div class='__propertyItem'><span class='__propertyLabel'>{name}:</span><input class='__checkboxPropertyField' id='__inputProperty{name}' type='checkbox' cssName='{name}'></div>
    </div>
</body>

<script>
class LocalStore {
    static put(name, value) {
        window.localStorage.setItem(name, value);
    }

    static get (name) {
        return window.localStorage.getItem(name);
    }
}

String.prototype.replaceAll = function(search, replacement) {
    var target = this;
    return target.replace(new RegExp(search, 'g'), replacement);
};

var TAB_SPACES = 5;

var altKeyDown = false;
var ctrlKeyDown = false;
var hoverElement = undefined;
var selectedElement = undefined;
var currentEditor = undefined;
var currentPreview = undefined;

// For preserving section content visibility when we click on tags.
var sectionContentVisible = [];     

$(document).ready(() => initialize());

function initialize() {
    // Before wiring up events, setup the common containers.
    // let sv = LocalStore.get('sectionContentVisible') == "";
    // sectionContentVisible = (sv == "" ? [] : sv);
    initializeSections();
    setupButtonBar();
    setupSourcePropertiesContainer();
    setupPropertiesContainer();
    wireUpEvents();
    demo();
}

// The purpose of this is to take the simpler (more human friendly) version of this:
// {name:'Dimensions', styles: ['width', 'height', 'max-width', 'max-height']},
// and convert the styles to an array of objects that looks like this:
// styles: [{style:'width', control:'input'}]
// That way we can get rid off all the horrid if-else checks when dealing with the style formatting.
function initializeSections()
{
    sections.forEach(s => {
        let i = 0;
        for (i = 0; i < s.styles.length; i++) {
            if (typeof(s.styles[i]) == 'string') {
                s.styles[i] = {style: s.styles[i], control: 'input'};
            }
        }
    });
}

function wireUpEvents() {
    $('#__editorh').keyup(event => editorKeyPress(event, '#__editorh', '#__previewh'));
    $('#__editorv').keyup(event => editorKeyPress(event, '#__editorv', '#__previewv'));
    $('#__editorh').keydown(event => editorKeyDown(event, '#__editorh', '#__previewh'));
    $('#__editorv').keydown(event => editorKeyDown(event, '#__editorv', '#__previewv'));
    $('.__preview').mouseover(event => previewMouseOver(event.target));
    $('.__preview').mouseleave(event => clearProperties());
    $('.__preview').click(event => previewClick(event));
    $('.__showHorizontal').click(() => showHorizontalLayout());
    $('.__showVertical').click(() => showVerticalLayout());
    $('.__clearEditors').click(() => clearEditors());
    $('.__save').click(() => save());

    // Handle CR
    $('.__propertyName').keypress((event) => propertyNameKeyPress(event));
    $('.__propertyId').keypress((event) => propertyIdKeyPress(event));

    // Handle lose focus
    $('.__propertyName').blur((event) => {
        updateElementName(event);
        updateSource();
    });

    $('.__propertyId').blur((event) => {
        updateElementId(event);
        updateSource();
    });

    showHorizontalLayout();
}

function setupButtonBar() {
    let html = $('#__sourceButtonBar').html();
    $('.__buttonBar').html(html);
}

var sections = [
        {name:'Dimensions', styles: ['width', 'height', 'max-width', 'max-height']},
        {name:'Margins', styles: ['margin-top', 'margin-right', 'margin-bottom', 'margin-left']},
        {name:'Padding', styles: ['padding-top', 'padding-right', 'padding-bottom', 'padding-left']},
        {name:'Font', styles: ['font-family', 'font-size', 'font-weight', 'font-style']},
        {name:'Border', styles: ['border-style', 'border-width', 'border-color', 'border-radius']},
        {name:'Flags', styles: [{style:'readonly', control:'checkbox'}]}
    ];

var tagSections = [
    {tag: 'input', sections: ['Margins', 'Padding', 'Flags']},
    {tag: 'p', sections: ['Dimensions', 'Margins', 'Padding', 'Font', 'Border']},
    {tag: 'div', sections: ['Dimensions', 'Margins', 'Padding', 'Border']},
];

function setupSourcePropertiesContainer() {
    let sectionNames = sections.map(s => s.name);

    let sectionTemplate = $('#__sectionTemplate').html();
    let sectionContent = [];
    let sectionNameIds = [];
    
    sectionNames.forEach(n =>
    {
        let sectionName = '__sectionName' + n;
        let contentName = '__content' + n;
        let st = sectionTemplate.replaceAll('{sectionName}', n);
        st = st + "<div class='" + contentName + "'>";
        st = insertStyles(sections.filter(s => s.name == n)[0].styles, st);
        st = st + "</div>";
        sectionContent.push(st);
        sectionNameIds.push({section: '#' + sectionName, content: '.' + contentName});

        // All section content initially visible
        sectionContentVisible['.' + contentName] = true;
    });

    // LocalStore.put('sectionContentVisible', 1);

    $("#__sections").html(sectionContent.join(''));

    sectionNameIds.forEach(sni =>
    {
        // When clicking on the section div, show or hide the content.
        // This doesn't work:
        // $(sni.section).on('click', () => showOrHideContent(sni.content));
        // We have to wire this up at the document level and pass in the selector!
        // See: https://stackoverflow.com/a/29674985/2276361
        $(document).on('click', sni.section, () => showOrHideSectionContent(sni.content));
    })

    // Also wire up future property style input boxes and checkbox events.
    sections.forEach(section =>
    {
        section.styles.filter(s=>s.control=='input').forEach(sectStyle =>
        {
            let inputElement = '#__inputProperty' + sectStyle.style;
            $(document).on('keydown', inputElement, onInputKeyPress);
            $(document).on('blur', inputElement, onUpdateElementStyle);
        });

        section.styles.filter(s=>s.control=='checkbox').forEach(sectStyle =>
        {
            let inputElement = '#__inputProperty' + sectStyle.style;
            $(document).on('click', inputElement, onCheckbox);
        });
    });
}

function onCheckbox(event) {
    let el = $('#' + event.currentTarget.id);
    let attr = $(el).attr('cssName');
    let checked = el.is(':checked');
    $(selectedElement).prop(attr, checked);       
    updateSource();
}

function onInputKeyPress(event) {
    if (event.keyCode == 13) {
        let el = $('#' + event.target.id);
        let attr = $(el).attr('cssName');
        let val = el.val();
        $(selectedElement).css(attr, val);       
        updateSource();
    }
}

function onUpdateElementStyle(event) {
    let el = $('#' + event.target.id);
    let attr = $(el).attr('cssName');
    let val = el.val();
    $(selectedElement).css(attr, val);       
    updateSource();
}

function propertyNameKeyPress(event) {
    if (event.keyCode == 13) {
        updateElementName(event);
        updateSource();
    }
}

function propertyIdKeyPress(event) {
    if (event.keyCode == 13) {
        updateElementId(event);
        updateSource();
    }
}

function updateSource() {
    let editor = $(currentEditor);
    let preview = $(currentPreview);
    let text = preview.html();
    editor.val(text);
}

/*
function updateElementStyle(event) {
    let el = $('#' + event.target.id);
    let val = el.val();
    let attr = $(el).attr('cssName');
    $(selectedElement).css(attr, val);       
}
*/

function updateElementName(event) {
    let el = $(event.currentTarget);
    let val = el.val();
    $(selectedElement).attr('name', val);       
}

function updateElementId(event) {
    let el = $(event.currentTarget);
    let val = el.val();
    $(selectedElement).attr('id', val);       
}

function insertStyles(styles, template) {
    let styleTemplate = $('#__styleTemplate').html();

    styles.forEach(s =>
    {
        let overrideTemplate = $('#__' + s.control + 'StyleTemplate').html();
        template = template + overrideTemplate.replaceAll('{name}', s.style);
    });

    return template;
}

function showOrHideSectionContent(id) {
    if ($(id).hasClass('__hidden')) {
        $(id).removeClass('__hidden');
        sectionContentVisible[id] = true;
    } else {
        $(id).addClass('__hidden');
        sectionContentVisible[id] = false;
    }

    // LocalStore.put('sectionContentVisible', sectionContentVisible);
}

function setupPropertiesContainer() {
    let html = $('#__sourcePropertiesContainer').html();
    $('.__propertiesContainer').html(html);
}

// ctrl / alt / shift / meta
keymap = [
    {special: 'alt', key: 'C', insert: ['<code>', '</code>'] },
    {special: 'alt', key: 'P', insert: ['<pre>', '</pre>'] },
    {special: 'alt', key: 'B', insert: ['<b>', '</b>'], toggle: true },
    {special: 'alt', key: 'I', insert: ['<i>', '</i>'], toggle: true },
    {special: 'alt', key: '1', insert: ["<pre lang='cs'>", '</pre>'] },
    {special: 'alt', key: '2', insert: ["<pre lang='jscript'>", '</pre>'] },
    {special: 'alt', key: '3', insert: ["<pre lang='css'>", '</pre>'] },
];

function editorKeyPress(event, sourceEditor, targetPreview) {
    let key = String.fromCharCode(event.which);
    let editor = $(sourceEditor);
    let preview = $(targetPreview);
    let editorText = editor.val();

    if (ctrlKeyDown || altKeyDown) {
        let start = editor[0].selectionStart;
        let end = editor[0].selectionEnd;
        let s1 = editorText.substring(0, start);
        let s2 = editorText.substring(end);
        let between = editorText.substring(start, end);

        // TODO: Check that other metakeys aren't down
        // TODO: Handle combination of meta keys.
        // TODO: Maybe handle key combinations.
        if (altKeyDown) {
            map = keymap.filter(k => k.special == 'alt' && k.key == key);

            if (map.length == 1) {
                map = map[0];

                if (map.toggle) {
                    toggleTags(editor, preview, map.insert[0], map.insert[1], editorText, s1, between, s2, start, end);
                } else {
                    insertTags(editor, preview, map.insert[0], map.insert[1], s1, between, s2, end);
                }

                event.preventDefault();
            }
        }

        /*
        if (ctrlKeyDown) {
            switch(key) {            
            }
        }
        */
    } else {
        preview.html(editorText);
    }
}

function insertTags(editor, preview, t1, t2, s1, between, s2, end) {
    let newText = s1 + t1 + between + t2 + s2;
    let newIdx = end + t1.length + t2.length;
    $(editor).val(newText);                

    // Set cursor to end of selection.
    editor[0].selectionStart = newIdx;
    editor[0].selectionEnd = newIdx;

    preview.html(newText);
}

// Not the smartest toggling, as it doesn't search for the outermost tags but only
// if they are immediately adjecent to the selected text.
function toggleTags(editor, preview, t1, t2, editorText, s1, between, s2, start, end) {
    var newText = editorText;

    if (start - t1.length >= 0 && 
        (editorText.substring(start-t1.length, start) == t1) &&
        end + t1.length < editorText.length &&
        (editorText.substring(end, end + t2.length) == t2) ) {
        // Remove tags
        s1 = editorText.substring(0, start - t1.length);
        between = editorText.substring(start, end);
        s2 = editorText.substring(end + t2.length);
        newText = s1 + between + s2;
        $(editor).val(newText);                

        // Preserve selected text.
        editor[0].selectionStart = start - t1.length;
        editor[0].selectionEnd = end - t1.length;
    } else {
    // Add tags.
        newText = s1 + t1 + between + t2 + s2;
        $(editor).val(newText);                

        // Preserve selected text.
        editor[0].selectionStart = start + t1.length;
        editor[0].selectionEnd = end + t1.length;
    }

    preview.html(newText);
}

function insertTab(editor, preview) {
    let editorText = $(editor).val();
    let start = $(editor)[0].selectionStart;
    let end = $(editor)[0].selectionEnd;
    let s1 = editorText.substring(0, start);
    let s2 = editorText.substring(end);

    // TODO: Handle replacing selection with TAB_SPACES if start != selectionEnd

    let newText = s1 + ' '.repeat(TAB_SPACES) + s2;
    $(editor).val(newText);
    $(editor)[0].selectionStart = start + TAB_SPACES;
    $(editor)[0].selectionEnd = start + TAB_SPACES;
    $(preview).html(newText);
}

function removeTab(editor, preview) {
    let start = $(editor)[0].selectionStart;
    let end = $(editor)[0].selectionEnd;

    if (start > 0 && start == end) {
        let editorText = $(editor).val();

        // wherever we are, remove up to TAB_SPACES whitespace from the left.
        let n = 0;
        while (n < TAB_SPACES && editorText[start - 1 - n] == ' ') ++n;

        start = start - n;
        let s1 = editorText.substring(0, start);
        let s2 = editorText.substring(end);
        let newText = s1 + s2;
        $(editor).val(newText);
        $(editor)[0].selectionStart = start;
        $(editor)[0].selectionEnd = start;
        $(preview).html(newText);
    }
}

// The event wired up here creates a gazillion events as long as the ALT key
// is pressed.  There must be a better way!
function editorKeyDown(event, editor, preview) {
    altKeyDown = event.altKey;
    ctrlKeyDown = event.ctrlKey;

    if (event.keyCode == 9 && !event.shiftKey) {
        insertTab(editor, preview);
        event.preventDefault();
    } else if (event.keyCode == 9 && event.shiftKey) {
        removeTab(editor, preview);
        event.preventDefault();
    }
}

function previewClick(event) {
    selectedElement = hoverElement;

    if (selectedElement) {
        showProperties(selectedElement);
    } else {
        clearProperties();
    }
}

function previewMouseOver(element) {
    // Setup for mouse click elsewhere.
    if (element.classList.contains('__preview')) {
        hoverElement = undefined;
    } else {
        hoverElement = element;
    }

    // Ignore the __preview box itself and, if we have a selected element, don't update the property list during a hover.
    if (!element.classList.contains('__preview') && !selectedElement) {
        showProperties(element);
    }
    else {
        clearProperties();
    }
}

function showProperties(element) {
    let tagName = element.tagName;
    $('.__elementTagName').text(tagName);
    $('.__propertiesContainer').removeClass('__hidden');
    $('.__propertyName').val($(element).attr('name'));
    $('.__propertyId').val($(element).attr('id'));
    showAllowableSections(tagName);
    populateStyleValues(element, tagName);
}

function clearProperties() {
    if (!selectedElement) {
        $('.__elementTagName').text('');
        $('.__propertiesContainer').addClass('__hidden');
        hoverElement = undefined;
    }
}

function showAllowableSections(tagName) {
    let lcTagName = tagName.toLowerCase();
    let sectionNames = sections.map(s => s.name);
    let allowableSections = tagSections.filter(s => s.tag == lcTagName)[0].sections;

    sectionNames.forEach(sn => {
        let sectionName = '.__sectionName' + sn;
        let contentName = '.__content' + sn;
        if (allowableSections.includes(sn)) {
            $(sectionName).removeClass('__hidden');

            // Restore state when section can be displayed.
            if (sectionContentVisible[contentName]) {
                $(contentName).removeClass('__hidden');
            } else {
                $(contentName).addClass('__hidden');
            }
        } else {
            // always hide if excluded.
            $(sectionName).addClass('__hidden');
            $(contentName).addClass('__hidden');
        }
    });
}

function populateStyleValues(el, tagName) {
    let lcTagName = tagName.toLowerCase();
    let sectionNames = sections.map(s => s.name);
    let allowableSections = tagSections.filter(s => s.tag == lcTagName)[0].sections;

    allowableSections.forEach(s =>
    {
        if (sections.filter(section => section.name == s).length > 0) {
            let sectionStyles = sections.filter(section => section.name == s)[0].styles;
            sectionStyles.forEach(sectStyle =>
            {
                let styleValue = $(el).css(sectStyle.style);
                let inputElement = '#__inputProperty' + sectStyle.style;
                $(inputElement).val(styleValue);
            });
        } else {
            console.log('Section ' + s + ' is not defined.');
        }
    });
}

function showVerticalLayout() {
    copy('h', 'v');
    $('#__verticalView').removeClass('__hidden');
    $('#__horizontalView').addClass('__hidden');
    currentEditor = '#__editorv';
    currentPreview = '#__previewv';
}

function showHorizontalLayout() {
    copy('v', 'h');
    $('#__verticalView').addClass('__hidden');
    $('#__horizontalView').removeClass('__hidden');
    currentEditor = '#__editorh';
    currentPreview = '#__previewh';
}

function clearEditors() {
    $('#__editorh').val('');
    $('#__editorv').val('');
    $('#__previewh').html('');
    $('#__previewv').html('');
}

function save() {
    let editor = $(currentEditor);
    let text = editor.val();
    download('content.html', text);
}

// https://ourcodeworld.com/articles/read/189/how-to-create-a-file-and-generate-a-download-with-javascript-in-the-browser-without-a-server
function download(filename, text) {
    var element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    element.setAttribute('download', filename);

    element.style.display = 'none';
    document.body.appendChild(element);

    element.click();

    document.body.removeChild(element);
}

function demo() {
    let demoText="<style>\np {\n\n  margin: 0px 0px 0px 5px;\n}\n</style>\n<p id='hi'>Hello World!</p><div id='div'>DIV Content</div><input value='An Input'></input>";
    $('#__editorv').val(demoText);
    $('#__previewv').html(demoText);
    $('#__editorh').val(demoText);
    $('#__previewh').html(demoText);
    // showVerticalLayout();
}

// Copy from one editor to the other
function copy(esource, etarget) {
    let edSource = '#__editor' + esource;
    let edTarget = '#__editor' + etarget;
    let pTarget = '#__preview' + etarget;
    let editorText = $(edSource).val();
    $(edTarget).val(editorText);
    $(pTarget).html(editorText);
}

</script>