<!--
    Styles defined here carry into the __preview because it's embedded HTML.
    So any styles names common to the editor's HTML will pick up the styles used in the editor!
    Javascript does not run because the document is already "ready".

let el = document.getElementById('div');

$(el).css('width')
$(el).css('width', '50%')
-->

<head>
    <script src='https://code.jquery.com/jquery-3.4.1.min.js'></script>
</head>

<style>
    /* https://developer.mozilla.org/en-US/docs/Web/CSS/Using_CSS_custom___properties */
    :root {
        --__propertyWidth: 250px;
        --__toolbarHeight: 30px;
        --__propertyLabelWidth: 100px;
        --__propertyFieldWidth: 115px;
    }
/*
    div {
        border-style:solid;
        border-width: 1px;
    }

    table {
        border-style:solid;
        border-width: 1px;
    }

    th {
        border-style:solid;
        border-width: 1px;
    }

    tr {
        border-style:solid;
        border-width: 1px;
    }

    td {
        border-style:solid;
        border-width: 1px;
    }
*/
    body {
        padding:0; 
        margin:0;
    }

    textarea {
        border-style:none;
    }

    .__noborders {
        border-collapse: collapse;    
    }

    .__border1 {
        border-style:solid;
        border-width: 1px;
    }

/* Absolution positioning should be avoided like the plague! */
/*
    .__fullscreen {
        height: 100%;
        width: 100%; 
        position: absolute; 
        top: 0; 
        bottom: 0; 
        left: 0; 
        right: 0;
        table-layout: fixed;
    }
*/

    .__fullscreen {
        width:calc(100% - 5px); 
        height:calc(100vh - 35px); /* why can't I use var(--toolbarHeight) ? */
        padding: 0;
        margin: 0;
    }

/*
    .__fullscreenv {
        height: 100%;
        width: calc(100% - (var(--__propertyWidth) + 2px)); 
        position: absolute; 
        top: 0; 
        bottom: 0; 
        left: 0; 
        right: 0;
    }
*/

    .__editorhw {
        width: calc(100% - var(--__propertyWidth));
    }

    .__properties {
        width: var(--__propertyWidth);
    }

    .__taeditorh {
        height: calc(100% - var(--__toolbarHeight));
        width: 100%;
        resize: none;
        padding: 0;
        margin: 0;
        white-space:normal;   /* or auto? */
        overflow: auto;
    }

    .__taeditorv {
        height: 100%;
        width: 100%;
        resize: none;
        padding: 0;
        margin: 0;
        white-space:normal;   /* or auto? */
        overflow: auto;
    }

    .__h100p {
        height: 100%;
    }

    .__text-bold {
        font-weight: bold;
    }

    .__mw1px {
        max-width: 1px;
    }

    .__preview {
        overflow: auto;
        white-space: normal;
    }

    .__fixed {
        table-layout: fixed;
    }

    .__fill {
        width:100%; 
        height:100%;
    }

    .__vamiddle {
        vertical-align: middle;
    }

    .__toolbar {
        height: var(--__toolbarHeight);
        width: 100%;
        padding-left: 5px;
    }

    .__parent {display: table;}

    .__child-top-left {
        display: table-cell;
    }

    .__child-middle-left {
        display: table-cell;
        vertical-align: middle;
        text-align: left;
    }

    .__child-middle-center {
        display: table-cell;
        vertical-align: middle;
        text-align: center;
    }

    .__child-bottom-right {
        display: table-cell;
        vertical-align: bottom;
        text-align: right;
    }

    .__hidden {
        display: none;
    }

    .__propertyLabel {
        float: left;   /* without this, width is ignored */
        width: var(--__propertyLabelWidth);
    }

    .__propertyField {
        width: var(--__propertyFieldWidth);
        margin-left: 5px;
    }

    .__propertyItem {
        margin-bottom:3px;
        padding-left: 5px;
    }

    .__section {
        background-color: #ddd;
        margin-top: 7px;
        margin-bottom: 3px;
    }

    .__sectionBar {
        padding-left: 5px;
        padding-bottom: 1px;
    }

</style>

<body>
    <!-- 3 Horizontal panels -->

    <div class='__fullscreen __hidden' id='__horizontalView'>    
        <div class='__parent __toolbar'>
            <div class="__child-middle-left __buttonBar"></div>
        </div>
        <table class='__noborders __fixed __fill'>
            <tr>
                <td class='__editorhw'>
                    <div class='__h100p __border1'>
                        <textarea class='__taeditorh' id='__editorh'></textarea>
                    </div>
                </td>
                <td class='__mw1px'>
                    <div class='__preview __h100p __border1' id='__previewh'></div>
                </td>
                <td class='__properties'>
                    <div class='__h100p  __border1'>
                        <div class='__propertiesContainer'></div>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <!-- top and bottom editor and __preview with __properties sidebar -->

    <div class='__fullscreen' id='__verticalView'>
        <table class='__noborders __fill'>
            <tr style='height:1px;'>
                <div class='__parent __toolbar'>
                    <div class="__child-middle-left __buttonBar"></div>
                </div>
            </tr>
            <tr>
                <td>
                    <table class='__noborders __fill'>
                        <tr>
                            <td>
                                <div class='__h100p __border1'>
                                    <textarea class='__taeditorv' id='__editorv'></textarea>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td class='__mw1px'>
                                <div class='__preview __border1 __h100p' id='__previewv'></div>
                            </td>
                        </tr>
                    </table>
                </td>
                <td class='__properties'>
                    <div class='__h100p __border1 __propertiesContainer'></div>
                </td>
            </tr>
        </table>
    </div>    

    <div class='__hidden' id='__sourceButtonBar'>
        <button class='showHorizontal'>Horizontal</button>
        <button class='showVertical'>Vertical</button>
        <button class='clearEditors'>Clear</button>
    </div>

    <div class='__hidden' id = '__sourcePropertiesContainer'>
        <div class='__propertyItem'>Element: <span class='__text-bold __elementTagName'></span></div>
        <div class='__propertyItem'><span class='__propertyLabel'>Name:</span><input class='__propertyField'></div>
        <div class='__propertyItem'><span class='__propertyLabel'>ID:</span><input class='__propertyField'></div>
        <div id='__sections'></div>
    </div>

    <div class='__hidden' id = '__sectionTemplate'>
        <div class='__propertItem __section __sectionBar' id='__sectionName{sectionName}'>{sectionName}</div>
    </div>

    <div class='__hidden' id = '__styleTemplate'>
        <div class='__propertyItem'><span class='__propertyLabel'>{name}:</span><input class='__propertyField' id='__inputProperty{name}' cssName='{name}'></div>
    </div>
    </body>

<script>
String.prototype.replaceAll = function(search, replacement) {
    var target = this;
    return target.replace(new RegExp(search, 'g'), replacement);
};

var altKeyDown = false;
var ctrlKeyDown = false;
var hoverElement = undefined;
var selectedElement = undefined;

// For preserving section content visibility when we click on tags.
var sectionContentVisible = [];     

$(document).ready(() => initialize());

function initialize() {
    // Before wiring up events, setup the common containers.
    setupButtonBar();
    setupSourcePropertiesContainer();
    setupPropertiesContainer();
    wireUpEvents();
    demo();
}

function wireUpEvents() {
    $('#__editorh').keyup(event => editorKeyPress(event.which, '#__editorh', '#__previewh'));
    $('#__editorv').keyup(event => editorKeyPress(event.which, '#__editorv', '#__previewv'));
    $('#__editorh').keydown(event => editorKeyDown(event));
    $('#__editorv').keydown(event => editorKeyDown(event));
    $('.__preview').mouseover(event => previewMouseOver(event.target));
    $('.__preview').mouseleave(event => clearProperties());
    $('.__preview').keydown(event => previewKeyDown(event));
    $('.__preview').click(event => previewClick(event));
    $('.showHorizontal').click(() => showHorizontalLayout());
    $('.showVertical').click(() => showVerticalLayout());
    $('.clearEditors').click(() => clearEditors());
    showHorizontalLayout();
}

function setupButtonBar() {
    let html = $('#__sourceButtonBar').html();
    $('.__buttonBar').html(html);
}

var sections = [
        {name:'Dimensions', styles: ['width', 'height', 'max-width', 'max-height']},
        {name:'Margins', styles: ['margin-top', 'margin-right', 'margin-bottom', 'margin-left']},
        {name:'Padding', styles: ['padding-top', 'padding-right', 'padding-bottom', 'padding-left']},
        {name:'Font', styles: ['font-family', 'font-size', 'font-weight', 'font-style']},
        {name:'Border', styles: ['border-style', 'border-width', 'border-color', 'border-radius']},
    ];

var tagSections = [
    {tag: 'p', sections: ['Dimensions', 'Margins', 'Padding', 'Font', 'Border']},
    {tag: 'div', sections: ['Dimensions', 'Margins', 'Padding', 'Border']}
];

function setupSourcePropertiesContainer() {
    let sectionNames = sections.map(s => s.name);

    let sectionTemplate = $('#__sectionTemplate').html();
    let sectionContent = [];
    let sectionNameIds = [];
    
    sectionNames.forEach(n =>
    {
        let sectionName = '__sectionName' + n;
        let contentName = '__content' + n;
        let st = sectionTemplate.replaceAll('{sectionName}', n);
        st = st + "<div id='" + contentName + "'>";
        st = insertStyles(sections.filter(s => s.name == n)[0].styles, st);
        st = st + "</div>";
        sectionContent.push(st);
        sectionNameIds.push({section: '#' + sectionName, content: '#' + contentName});

        // All section content initially visible
        sectionContentVisible['#' + contentName] = true;
    });

    $("#__sections").html(sectionContent.join(''));

    sectionNameIds.forEach(sni =>
    {
        // When clicking on the section div, show or hide the content.
        // This doesn't work:
        // $(sni.section).on('click', () => showOrHideContent(sni.content));
        // We have to wire this up at the document level and pass in the selector!
        // See: https://stackoverflow.com/a/29674985/2276361
        $(document).on('click', sni.section, () => showOrHideSectionContent(sni.content));
    })

    // Also wire up future property style input boxes events.
    sections.forEach(section =>
    {
        section.styles.forEach(sectStyle =>
        {
            let inputElement = '#__inputProperty' + sectStyle;
            $(document).on('keypress', inputElement, onInputKeyPress);
        });
    });
}

function onInputKeyPress(event) {
    if (event.keyCode == 13) {
        let el = $('#' + event.target.id);
        let val = el.val();
        let attr = $(el).attr('cssName');
        $(selectedElement).css(attr, val);       
    }
}

function insertStyles(styles, template) {
    let styleTemplate = $('#__styleTemplate').html();

    styles.forEach(s =>
    {
        template = template + styleTemplate.replaceAll('{name}', s);
    });

    return template;
}

function showOrHideSectionContent(id) {
    if ($(id).hasClass('__hidden')) {
        $(id).removeClass('__hidden');
        sectionContentVisible[id] = true;
    } else {
        $(id).addClass('__hidden');
        sectionContentVisible[id] = false;
    }
}

function setupPropertiesContainer() {
    let html = $('#__sourcePropertiesContainer').html();
    $('.__propertiesContainer').html(html);
}

function editorKeyPress(key, sourceEditor, targetPreview) {
    let editor = $(sourceEditor);
    let preview = $(targetPreview);
    let editorText = editor.val();

    if (altKeyDown) {
        let start = editor[0].selectionStart;
        let end = editor[0].selectionEnd;
        let s1 = editorText.substring(0, start);
        let s2 = editorText.substring(end);
        let between = editorText.substring(start, end);

        switch(key) {
            // TODO: argh, why uppercase?  Maybe instead convert key to its charcode?
            case 'C'.charCodeAt(0):
                insertTags(editor, preview, '<code>', '</code>', s1, between, s2, end);
                break;
            case 'P'.charCodeAt(0):
                insertTags(editor, preview, '<pre>', '</pre>', s1, between, s2, end);
                break;
            case 'B'.charCodeAt(0):
                toggleTags(editor, preview, '<b>', '</b>', editorText, s1, between, s2, start, end);
                break;
            case 'I'.charCodeAt(0):
                toggleTags(editor, preview, '<i>', '</i>', editorText, s1, between, s2, start, end);
                break;
        }
    } else {
        preview.html(editorText);
    }
}

function insertTags(editor, preview, t1, t2, s1, between, s2, end) {
    let newText = s1 + t1 + between + t2 + s2;
    let newIdx = end + t1.length + t2.length;
    $(editor).val(newText);                

    // Set cursor to end of selection.
    editor[0].selectionStart = newIdx;
    editor[0].selectionEnd = newIdx;

    preview.html(newText);
}

// Not the smartest toggling, as it doesn't search for the outermost tags but only
// if they are immediately adjecent to the selected text.
function toggleTags(editor, preview, t1, t2, editorText, s1, between, s2, start, end) {
    var newText = editorText;

    if (start - t1.length >= 0 && 
        (editorText.substring(start-t1.length, start) == t1) &&
        end + t1.length < editorText.length &&
        (editorText.substring(end, end + t2.length) == t2) ) {
        // Remove tags
        s1 = editorText.substring(0, start - t1.length);
        between = editorText.substring(start, end);
        s2 = editorText.substring(end + t2.length);
        newText = s1 + between + s2;
        $(editor).val(newText);                

        // Preserve selected text.
        editor[0].selectionStart = start - t1.length;
        editor[0].selectionEnd = end - t1.length;
    } else {
    // Add tags.
        newText = s1 + t1 + between + t2 + s2;
        $(editor).val(newText);                

        // Preserve selected text.
        editor[0].selectionStart = start + t1.length;
        editor[0].selectionEnd = end + t1.length;
    }

    preview.html(newText);
}

// The event wired up here creates a gazillion events as long as the ALT key
// is pressed.  There must be a better way!
function editorKeyDown(event) {
    altKeyDown = event.altKey;
    ctrlKeyDown = event.ctrlKey;
}

function previewClick(event) {
    selectedElement = hoverElement;

    if (selectedElement) {
        showProperties(selectedElement);
    } else {
        clearProperties();
    }
}

function previewMouseOver(element) {
    // Setup for mouse click elsewhere.
    if (element.classList.contains('__preview')) {
        hoverElement = undefined;
    } else {
        hoverElement = element;
    }

    // Ignore the __preview box itself and, if we have a selected element, don't update the property list during a hover.
    if (!element.classList.contains('__preview') && !selectedElement) {
        showProperties(element);
    }
    else {
        clearProperties();
    }
}

function showProperties(element) {
    let tagName = element.tagName;
    $('.__elementTagName').text(tagName);
    $('.__propertiesContainer').removeClass('__hidden');
    showAllowableSections(tagName);
    populateStyleValues(element, tagName);
}

function clearProperties() {
    if (!selectedElement) {
        $('.__elementTagName').text('');
        $('.__propertiesContainer').addClass('__hidden');
        hoverElement = undefined;
    }
}

function showAllowableSections(tagName) {
    let lcTagName = tagName.toLowerCase();
    let sectionNames = sections.map(s => s.name);
    let allowableSections = tagSections.filter(s => s.tag == lcTagName)[0].sections;

    sectionNames.forEach(sn => {
        let sectionName = '#__sectionName' + sn;
        let contentName = '#__content' + sn;
        if (allowableSections.includes(sn)) {
            $(sectionName).removeClass('__hidden');

            console.log(sectionContentVisible);

            // Restore state when section can be displayed.
            if (sectionContentVisible[contentName]) {
                $(contentName).removeClass('__hidden');
            } else {
                $(contentName).addClass('__hidden');
            }
        } else {
            // always hide if excluded.
            $(sectionName).addClass('__hidden');
            $(contentName).addClass('__hidden');
        }
    });
}

function populateStyleValues(el, tagName) {
    let lcTagName = tagName.toLowerCase();
    let sectionNames = sections.map(s => s.name);
    let allowableSections = tagSections.filter(s => s.tag == lcTagName)[0].sections;

    allowableSections.forEach(s =>
    {
        let sectionStyles = sections.filter(section => section.name == s)[0].styles;
        sectionStyles.forEach(sectStyle =>
        {
            let styleValue = $(el).css(sectStyle);
            let inputElement = '#__inputProperty' + sectStyle;
            $(inputElement).val(styleValue);
        });
    });
}

function showVerticalLayout() {
    copy('h', 'v');
    $('#__verticalView').removeClass('__hidden');
    $('#__horizontalView').addClass('__hidden');
}

function showHorizontalLayout() {
    copy('v', 'h');
    $('#__verticalView').addClass('__hidden');
    $('#__horizontalView').removeClass('__hidden');
}

function clearEditors() {
    $('#__editorh').val('');
    $('#__editorv').val('');
    $('#__previewh').html('');
    $('#__previewv').html('');
}

function demo() {
    let demoText="<style>\np {\n\n  margin: 0px 0px 0px 5px;\n}\n</style>\n<p id='hi'>Hello World!</p><div id='div'>DIV Content</div>";
    $('#__editorv').val(demoText);
    $('#__previewv').html(demoText);
    $('#__editorh').val(demoText);
    $('#__previewh').html(demoText);
}

// Copy from one editor to the other
function copy(esource, etarget) {
    let edSource = '#__editor' + esource;
    let edTarget = '#__editor' + etarget;
    let pTarget = '#__preview' + etarget;
    let editorText = $(edSource).val();
    $(edTarget).val(editorText);
    $(pTarget).html(editorText);
}

</script>